<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chess Engine with CNN</title>
  <link rel="stylesheet" href="web/chessboard.css">
  <link rel="stylesheet" href="web/style.css">
</head>
<body>
  <h1>Testing CNN Chess Engine</h1>
  <button id="playWhiteBtn">Play as White</button>
  <button id="playBlackBtn">Play as Black</button>
  <div id="board"></div>
  <button id="flipBtn">Flip Board</button>

  <script src="web/jquery-3.7.1.min.js"></script>
  <script src="web/chess.js"></script>
  <script src="web/chessboard.js"></script>
  <script>
    console.clear();
    let userSide = 'b';
    let game = new Chess();
    const playWhiteBtn = document.getElementById('playWhiteBtn');
    const playBlackBtn = document.getElementById('playBlackBtn');

    // initialize board
    const board = Chessboard('board', {
      position: 'start',
      pieceTheme: 'web/chesspieces/{piece}.png',
      draggable: true,
      dropOffBoard: 'snapback',
      onDragStart: (src, piece) => {
        if (game.game_over() || game.turn() !== userSide) return false;
      },
      onDrop: (source, target) => {
        const moves = game.moves({ square: source, verbose: true });
        const mv = moves.find(m => m.to === target);
        if (!mv) return 'snapback';
        const uci = source + target + (mv.promotion || '');
        sendMove(uci);
      }
    });

    playWhiteBtn.onclick = () => {
      userSide = 'w';
      triggerReset();
    };
    playBlackBtn.onclick = () => {
      userSide = 'b';
      triggerReset();
    };
    document.getElementById('flipBtn').onclick = () => board.flip();

    function sendMove(moveStr) {
      fetch('/move', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ move: moveStr })
      })
      .then(r => r.json())
      .then(data => {
        game = new Chess(data.fen);
        board.position(data.fen, true);
        triggerEngineMove();
      })
      .catch(console.error);
    }

    function triggerEngineMove() {
      fetch('/engine_move', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          game = new Chess(data.fen);
          board.position(data.fen, true);
        })
        .catch(console.error);
    }

    function triggerReset() {
      fetch('/reset', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_side: userSide })
      })
      .then(r => r.json())
      .then(data => {
        game = new Chess(data.fen);
        board.position(data.fen, true);
      })
      .catch(console.error);
    }
  </script>
</body>
</html>