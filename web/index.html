<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Chess Engine with CNN</title>
    <link rel="stylesheet" href="chessboard.css">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1>Testing CNN Chess Engine</h1>
    <button id="playWhiteBtn">Play as White</button>
    <button id="playBlackBtn">Play as Black</button>

    <div id="board"></div>
    <button id="flipBtn">Flip Board</button>

    <script src="jquery-3.7.1.min.js"></script>
    <script src="chess.js"></script>
    <script src="chessboard.js"></script>
    
    <script>
      // Which side the human is playing: 'b' = Black, 'w' = White
      var userSide = 'b';

      // Initialize a local chess.js board and chessboard.js UI
      var game = new Chess();
      var board = Chessboard('board', {
        position: 'start',
        pieceTheme: 'chesspieces/{piece}.png',
        draggable: true,
        dropOffBoard: 'snapback',
        onDragStart: function(source, piece) {
          if (game.game_over() || game.turn() !== userSide) {
            return false;
          }
          // show legal move dots
          $('.legal-dot').remove();
          game.moves({ square: source, verbose: true }).forEach(mv => {
            $('[data-square="' + mv.to + '"]').append('<div class="legal-dot"></div>');
          });
        },
        onSnapEnd: function() {
          $('.legal-dot').remove();
        },
        onDrop: function(source, target) {
          // find the move object
          const moves = game.moves({ square: source, verbose: true });
          const mv = moves.find(m => m.to === target);
          if (!mv) return 'snapback';

          // handle castling
          if (mv.san === "O-O" || mv.san === "O-O-O") {
            game.move({ from: source, to: target, promotion: 'q' });
            board.position(game.fen());
            sendMove(source + target);
            return;
          }

          // handle promotion
          if (mv.promotion) {
            setTimeout(() => {
              showPromotionDialog().then(promo => {
                game.move({ from: source, to: target, promotion: promo });
                board.position(game.fen());
                sendMove(source + target + promo);
              });
            }, 0);
            return 'snapback';
          }

          // normal move
          game.move({ from: source, to: target, promotion: 'q' });
          sendMove(source + target);
        }
      });

      // On page load: get a fresh board from the server
      triggerReset();

      // Side-selection buttons
      document.getElementById('playWhiteBtn').addEventListener('click', () => {
        userSide = 'w';
        alert("You are playing as White. Engine will play Black.");
        triggerReset();
      });
      document.getElementById('playBlackBtn').addEventListener('click', () => {
        userSide = 'b';
        alert("You are playing as Black. Engine will play White.");
        triggerReset();
      });

      // Flip board
      document.getElementById('flipBtn').addEventListener('click', () => board.flip());

      // Promotion modal helper
      function showPromotionDialog() {
        return new Promise(resolve => {
          $('#promotion-modal').removeClass('hidden');
          $('.promo-btn').one('click', function() {
            const p = $(this).data('piece');
            $('#promotion-modal').addClass('hidden');
            resolve(p);
          });
        });
      }

      // Send human move to /move
      function sendMove(moveStr) {
        fetch('/move', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            fen: game.fen(),
            move: moveStr
          })
        })
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
            board.position(game.fen());
          } else {
            game = new Chess(data.fen);
            board.position(data.fen, true);
            // engine move if it's now engine's turn
            if (game.turn() !== userSide) triggerEngineMove();
          }
        })
        .catch(console.error);
      }

      // Ask /engine_move for the engineâ€™s reply
      function triggerEngineMove() {
        fetch('/engine_move', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            fen: game.fen(),
            user_side: userSide
          })
        })
        .then(r => r.json())
        .then(data => {
          game = new Chess(data.fen);
          board.position(data.fen);
        })
        .catch(console.error);
      }

      // Reset or start a new game via /reset
      function triggerReset() {
        fetch('/reset', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ user_side: userSide })
        })
        .then(r => r.json())
        .then(data => {
          game = new Chess(data.fen);
          board.position(data.fen);
        })
        .catch(console.error);
      }

      // Clean up dots on mouse up/touch end
      $(document).on('mouseup touchend', () => $('.legal-dot').remove());
    </script>

    <!-- Promotion modal -->
    <div id="promotion-modal" class="modal hidden">
      <div class="modal-content">
        <h3>Choose Promotion</h3>
        <button class="promo-btn" data-piece="q">Queen</button>
        <button class="promo-btn" data-piece="r">Rook</button>
        <button class="promo-btn" data-piece="b">Bishop</button>
        <button class="promo-btn" data-piece="n">Knight</button>
      </div>
    </div>
  </body>
</html>
